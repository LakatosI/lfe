#!/usr/bin/env lfe
;;; -*- lfe -*-

(defun docs (file) (docs file '[binary]))

(defun docs (file opts)
  (let* ((opts*                   (ordsets:add_element 'binary opts))
         (`#(ok [#(ok ,_ ,beam)]) (lfe_comp:file file opts*))
         (`#(ok ,_ ,chunks)       (beam_lib:all_chunks beam))
         (no-docs                 (term_to_binary #"no-docs")))
    (case (proplists:get_value "LDoc" chunks)
      ('undefined #"no-docs")
      (ldoc       (binary_to_term ldoc)))))

(case script-args
  ([]
   (io:format (++ "Usage: docs {{file}}\n"
                  "       docs {{file}} {{compiler options}}\n")))
  (`[,file . ,opts]
   (lfe_io:format "~p\n"
     `[,(docs file (lists:map #'list_to_atom/1 opts))])))

;; $ cd /path/to/lfe
;; $ make
;; $ ./test/docs test/example.lfe
